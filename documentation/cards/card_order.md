# Порядок карточек

| Поле | Значение                                                                                                                                                 |
| --- |----------------------------------------------------------------------------------------------------------------------------------------------------------|
| Цель | Описать алгоритм выбора карточек для обечения и порядок их вывода                                                                                        |
| Аудитория | Разработчики, AI агент                                                                                                                                   |
| Ответственный | Команда разработки                                                                                                                                       |
| Связанные документы | [Типы карточек](./card_types.md), [ER-диаграмма](../data/er_diagram.puml), [История ответов](./card_history.md), [Прогресс карточек](./card_progress.md) |
| Ключевые классы | `LessonCardType`, `LessonCardTypeService`, `CardHistoryRepository`                                                                                       |

## Краткий обзор

Урок для пользователя состоит из набора карточек с заданиями. Список карточек для обучения формируется при каждом старте урока, выбирается из настроек `word_collection`. Из привязанных к коллекции слов и выбранных типов карточек и настроек для них.
Подбор карточек выполняется полностью на слое сервисов:
- Каждая реализация `LessonCardTypeService` подготавливает карточки, уже отфильтрованные по собственной логике готовности (статус, дата следующего повторения, особенности типа).
- `LessonCardService` агрегирует результаты и применяет общие ограничения (условия включения/исключения и сортировку).
Интерфейс `LessonCardTypeService` вызывается из `LessonCardService`, UI получает готовый список карточек.
Полученный список карточек в `LessonCardService` сортируется по дате и времени `next_review_date` перед передачей в UI.

## Базовая логика выбора карточек для обучения

Базовый выбор карточек выполняется поэтапно:
1. `LessonCardService` получает список типов карточек урока и извлекает связанный прогресс.
2. Для каждого типа вызывается `LessonCardTypeService.getCards`, где:
   - фильтруются карточки по состоянию (`StatusEnum`), времени следующего повторения и специфике типа;
   - подготавливаются DTO c актуальным статусом и рассчитанной датой следующего повторения.
3. `LessonCardService` объединяет результаты всех типов, применяет общие условия включения/исключения (см. ниже) и сортирует итоговый список по `next_review_date`.
Если у карточки отсутствует дата следующего повторения, она рассматривается как готовая к показу и попадает в начало списка.

## Дополнительные условия для выбора карточек

Дополнительно к базовой логике выбора карточек, для урока, имеется возможность указать условие при котором данный тип карточки будет или не будет использоваться в данном уроке. Для этого используется четыре не обязательных поля в `lesson_card_types`: `condition_on_card_type`, `condition_on_value`, `condition_off_card_type`, `condition_off_value`.
Поля `condition_on_card_type`, `condition_on_value` служат для определения условия при котором данный тип карточки включается. Поле `condition_on_card_type` определяет какой тип карточки влияет на условие, а поле `condition_on_value` количество правильных ответов, записанных в таблицу `card_history`, необходимо для включения данного типа карточки.
Поля `condition_off_card_type`, `condition_off_value` служат для определения условия при котором данный тип карточки исключается из списка. Поле `condition_of_card_type` определяет какой тип карточки влияет на условие, а поле `condition_off_value` количество правильных ответов, записанных в таблицу `card_history`, необходимо для выключения данного типа карточки.
Алгоритм применяется в `LessonCardService` при подготовке списка:
1. Запрашивается количество записей в `card_history`, где `lesson_id` совпадает с текущим уроком, `card_type` равен `condition_on_card_type` или `condition_off_card_type`, а `quality` больше ноля.
2. Если значение больше или равно `condition_on_value`, тип карточки включается в подбор (даже если изначально был выключен).
3. Если значение больше или равно `condition_off_value`, тип карточки исключается из списка (даже если изначально был активен).
Данные поля не обязательны, и при их отсутствии дополнительное условие игнорируется.
В UI выбора типов карточек (настройка коллекции) выпадающие списки условий содержат только активные типы; для условия включения текущий тип исключён, для отключения может быть выбран. При установке условия порог по умолчанию подставляется 10.

## Что менять при доработке

- Если добавляется новый тип карточки, реализуй `getCards` в `LessonCardTypeService` и реализуй алгоритм выбора генерации карточек для изучения.
- При изменении структуры таблицы `lesson_card_types` синхронизируй модель Room (`LessonProgress`) и ER-диаграмму.
