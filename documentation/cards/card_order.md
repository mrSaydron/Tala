# Порядок карточек

| Поле | Значение                                                                                                                                                 |
| --- |----------------------------------------------------------------------------------------------------------------------------------------------------------|
| Цель | Описать алгоритм выбора карточек для обечения и порядок их вывода                                                                                        |
| Аудитория | Разработчики, AI агент                                                                                                                                   |
| Ответственный | Команда разработки                                                                                                                                       |
| Связанные документы | [Типы карточек](./card_types.md), [ER-диаграмма](../data/er_diagram.puml), [История ответов](./card_history.md), [Прогресс карточек](./card_progress.md) |
| Ключевые классы | `LessonCardType`, `LessonCardTypeService`, `CardHistoryRepository`                                                                                       |

## Краткий обзор

Урок для пользователя состоит из набора карточек с заданиями. Список карточек для обучения формируется при каждом старте урока, выбирается из настроек `dictionary_collections`. Из привязанных к коллекции слов и выбранных типов карточек и настроек для них.
Логика для каждого типа карточек может отличаться и является реализацией интерфейса `LessonCardTypeService`, реализация которого вызывается из `LessonCardService`.
Полученный список карточек должен быть отсортирован по дате и времени `next_review_date`.

## Базовая логика выбора карточек для обучения

Базовый выбор карточек основан на дате следующего повторения, который берется из прогресса карточки: `lesson_progress.next_review_date`. Выбираются карточки дата которых раньше или равна текущей. Время при этом не проверяется и используется только для определения порядка в списке карточек. При этом конкретная реализация может брать слова дата повторения которых еще не наступила. Или напротив пропускать слова дата которых уже прошла.

## Дополнительные условия для выбора карточек

Дополнительно к базовой логике выбора карточек, для урока, имеется возможность указать условие при котором данный тип карточки будет или не будет использоваться в данном уроке. Для этого используется четыре не обязательных поля в `lesson_card_types`: `condition_on_card_type`, `condition_on_value`, `condition_off_card_type`, `condition_off_value`.
Поля `condition_on_card_type`, `condition_on_value` служат для определения условия при котором данный тип карточки включается. Поле `condition_on_card_type` определяет какой тип карточки влияет на условие, а поле `condition_on_value` количество правильных ответов, записанных в таблицу `card_history`, необходимо для включения данного типа карточки.
Поля `condition_off_card_type`, `condition_off_value` служат для определения условия при котором данный тип карточки исключается из списка. Поле `condition_of_card_type` определяет какой тип карточки влияет на условие, а поле `condition_off_value` количество правильных ответов, записанных в таблицу `card_history`, необходимо для выключения данного типа карточки.
Алгоритм следующий: запрашиваем в `card_history` количество записей со значением в поле `lesson_id` равном текущему уроку и с типом `condition_on_card_type` или `condition_off_card_type` и значением в поле `quality` больше ноля. И если это значение больше или равно `condition_on_value` или `condition_off_value`, то данный тип карточки соответственно либо включаем, либо выключаем.
Данные поля не обязательны, и при их отсутствии дополнительное условие игнорируется.

## Что менять при доработке

- Если добавляется новый тип карточки, реализуй `getCards` в `LessonCardTypeService` и реализуй алгоритм выбора генерации карточек для изучения.
- При изменении структуры таблицы `lesson_card_types` синхронизируй модель Room (`LessonProgress`) и ER-диаграмму.
