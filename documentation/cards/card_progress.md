# Прогресс карточек

| Поле | Значение |
| --- | --- |
| Цель | Описать модель данных прогресса и правила её обновления |
| Аудитория | Разработчики, AI агент |
| Ответственный | Команда разработки |
| Последнее обновление | 2025-12-23 |
| Связанные документы | [Типы карточек](./card_types.md), [ER-диаграмма](../data/er_diagram.mermaid) |
| Ключевые классы | `LessonProgressRepository`, `LessonCardTypeService`, `TranslateLessonCardTypeService` |

## Краткий обзор

Прогресс карточек хранится в таблице `lesson_progress`. За чтение и запись отвечают сущности `LessonProgress` и `LessonProgressRepository`, а логика обновления сосредоточена в реализациях `LessonCardTypeService`.

## Поля прогресса

Результат ответа пользователя влияет на план повторений. Основные поля прогресса:
- `next_review_date` — дата и время следующего повторения;
- `interval_minutes` — интервал между повторами в минутах;
- `ef` — коэффициент лёгкости (E-Factor);
- `status` — текущий статус карточки (`NEW`, `IN_PROGRESS`, `PROGRESS_RESET`), перечисление `StatusEnum`;
- `card_type` — тип карточки, перечисление `CardTypeEnum`;
- `dictionary_id` — идентификатор изучаемого слова;
- `lesson_id` — идентификатор урока;
- `info` — дополнительная информация для специфичных типов карточек.

Для расчёта следующей даты повторения используется алгоритм SuperMemo (SM-2). Качество ответа `q` варьируется от 0 (ошибка) до 5 (идеальный ответ). Интервал пересчитывается по формуле `I(n) = I(n-1) * ef`. Новый коэффициент лёгкости вычисляется как `ef' = ef + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02))`, при этом `ef` не может быть меньше 1.3.

Изменение статуса карточки зависит от качества ответа:
- При `q = 0` статус устанавливается в `PROGRESS_RESET`, `ef` пересчитывается, интервал сбрасывается до суток, а `next_review_date` устанавливается на текущее время плюс 10 минут. При повторной ошибке коэффициент не пересчитывается повторно.
- При `q > 0` и статусах `NEW` или `PROGRESS_RESET` `ef` не пересчитывается, интервал фиксируется на одних сутках, а дата следующего повторения рассчитывается от текущего момента.
- Для статуса `IN_PROGRESS` пересчитываются `ef`, интервал и `next_review_date` по формулам SM-2.

## Реализация

Метод `answerResult` принимает текущий прогресс и качество ответа. В зависимости от типа карточки делегируется вызов соответствующей реализации `LessonCardTypeService`. Для карточек типа `TRANSLATE` используется `TranslateLessonCardTypeService`, где обновление прогресса выполняется непосредственно.

## Что менять при доработке

- Добавляя новый тип карточки, реализуй `LessonCardTypeService` и определи обработку прогресса для соответствующих значений качества ответа.
- При изменении структуры таблицы `lesson_progress` синхронизируй модель Room (`LessonProgress`) и ER-диаграмму.
- Если меняется алгоритм повторений, обнови формулы SM-2 и примеры использования, а также тесты, покрывающие расчёт расписания.
